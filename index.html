<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Mapa de Quest - Everton Mereles Costa</title>
    <style>
        /* CSS Completo (o mesmo da √∫ltima vers√£o com a barra de stats fixa) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: auto;
            padding-top: 85px;
        }

        .quest-map {
            width: 100%;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .timeline {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            gap: 20px;
            margin: 40px 0;
            position: relative;
            flex-wrap: wrap;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 100px;
            left: 5%;
            right: 5%;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            border-radius: 2px;
            z-index: 1;
        }

        .phase {
            flex: 1 1 300px;
            max-width: 450px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
            cursor: default;
            margin-bottom: 20px;
        }

        .phase:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .phase.completed {
            background: rgba(0,255,136,0.2);
            border-color: #00ff88;
        }

        .phase.active {
            background: rgba(255,193,7,0.2);
            border-color: #ffc107;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255,193,7,0.2); }
            50% { box-shadow: 0 0 20px rgba(255,193,7,0.4); }
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .phase-icon {
            font-size: 3em;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        .phase-title-container {}
        .phase-title {
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .phase-subtitle {
            font-size: 1em;
            color: #eee;
        }

        .phase-timeline-desc {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .quest-list {
            margin: 20px 0;
        }

        .quest-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quest-item:hover {
            background: rgba(0,0,0,0.4);
            transform: translateX(5px);
        }

        .quest-item.completed {
            opacity: 0.6;
            border-left-color: #00ff88;
            text-decoration: line-through;
        }

        .quest-item.completed .quest-checkbox {
            background: #00ff88;
            border-color: #00ff88;
        }

        .quest-item.completed .quest-checkbox::after {
            content: '‚úî';
            color: white;
            display: block;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
        }

        .quest-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .quest-text {
            flex: 1;
            font-size: 1em;
        }

        .quest-xp {
            font-size: 0.8em;
            color: #ffc107;
            margin-left: auto;
            padding-left: 10px;
        }

        .reward-section {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .reward-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .reward-item { font-size: 0.9em; }

        .stats-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.90);
            padding: 10px 15px;
            border-radius: 0;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255,255,255,0.2);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-panel h3 {
            margin: 0 15px 5px 0;
            border-bottom: none;
            padding-bottom: 0;
            font-size: 1.1em;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .stat-item {
            margin: 5px 10px;
            padding: 0;
            border-bottom: none;
            text-align: center;
        }

        .stat-item span {
            display: block;
        }
        .stat-label {
            color: #ccc;
            font-size: 0.75em;
            margin-bottom: 2px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 0.9em;
        }

        .milestone-marker {
            position: absolute;
            top: 85px;
            background: #ffc107;
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
            z-index: 3;
            animation: bounce 2s infinite;
            transform: translateX(-50%);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translate(-50%, 0); }
            40% { transform: translate(-50%, -10px); }
            60% { transform: translate(-50%, -5px); }
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .achievement-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        .achievement-popup h2 { margin-bottom: 15px; }

        .next-quest-panel {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .next-quest-panel h3 {
            margin-bottom: 10px;
            color: #ffc107;
        }
        #nextQuestText { font-size: 1.1em; }
        #nextQuestDeadline { font-size: 0.9em; color: #ddd; margin-top: 5px; }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2c3e50; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 15px; color: white; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 15px; right: 25px; }
        .modal-close:hover, .modal-close:focus { color: #fff; text-decoration: none; }
        .modal h2 { color: #4ecdc4; margin-bottom: 20px; }
        .modal p { margin-bottom: 10px; }
        .modal textarea { width: 100%; min-height: 80px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; padding: 10px; border-radius: 8px; margin-top:10px; }
        .modal h4 { margin-top: 15px; color: #ffc107; }
        .modal ul { list-style: square; margin-left: 20px; }

        @media (max-width: 1200px) {
            .timeline {
                flex-direction: column;
                align-items: center;
            }
            .timeline::before {
                display: none;
            }
            .phase {
                flex-basis: 100%;
                max-width: 600px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding-top: 120px;
            }
            .stats-panel h3 {
                font-size: 1em;
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }
            .stat-label {
                font-size: 0.7em;
            }
            .stat-value {
                font-size: 0.85em;
            }
            .header h1 {
                font-size: 2em;
            }
        }
        @media (max-width: 480px) {
             body {
                padding-top: 150px;
            }
            .stats-panel {
                padding: 8px 5px;
            }
             .stats-panel h3 {
                font-size: 0.9em;
            }
            .stat-item {
                margin: 3px 5px;
            }
        }

    </style>
</head>
<body>
    <div class="stats-panel">
        <h3 id="playerNameDisplay">üìä STATS DO JOGADOR</h3>
        <div class="stat-item">
            <span class="stat-label">üåü N√≠vel:</span>
            <span class="stat-value" id="currentLevel">1 (Novato)</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">‚ú® XP:</span>
            <span class="stat-value" id="currentXP">0 / 100</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">üí∞ Receita Mensal:</span>
            <span class="stat-value" id="revenue">R$ 0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">üè¢ Clientes Ativos:</span>
            <span class="stat-value" id="clients">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">üéØ Quests Conclu√≠das:</span>
            <span class="stat-value" id="completedQuestsCount">0/0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">üî• Streak:</span>
            <span class="stat-value" id="streak">0 dias</span>
        </div>
    </div>

    <div class="quest-map">
        <div class="header">
            <h1 id="mainMissionTitle">üó∫Ô∏è MAPA DE QUEST</h1>
            <p id="mainMissionSubtitle">üéØ Miss√£o Principal: Carregando...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Progresso Geral: 0%</p>
        </div>

        <div class="timeline" id="timelineContainer">
            <!-- Phases will be injected here by JavaScript -->
        </div>

        <div class="next-quest-panel">
            <h3>üéØ PR√ìXIMA QUEST ATIVA</h3>
            <p id="nextQuestText">Carregando...</p>
            <p id="nextQuestDeadline">Carregando...</p>
        </div>
    </div>

    <div class="achievement-popup" id="achievementPopup">
        <h2 id="achievementTitle">üéâ CONQUISTA DESBLOQUEADA!</h2>
        <div id="achievementText"></div>
        <button onclick="closeAchievement()" style="margin-top: 20px; padding: 10px 20px; background: #fff; color: #000; border: none; border-radius: 10px; cursor: pointer;">Continuar!</button>
    </div>

    <div id="questDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeQuestDetailModal()">√ó</span>
            <h2 id="modalQuestTitle">Detalhes da Quest</h2>
            <p id="modalQuestDescription"></p>
            <h4>üöß Obst√°culos Potenciais:</h4>
            <ul id="modalQuestObstacles"></ul>
            <h4>üìù Minhas Anota√ß√µes:</h4>
            <textarea id="modalQuestNotes" placeholder="Suas anota√ß√µes, estrat√©gias, aprendizados..."></textarea>
            <button onclick="saveQuestNotes()" style="margin-top: 15px; padding: 10px 15px; background-color: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Anota√ß√µes</button>
        </div>
    </div>

    <script>
        // --- DATA DEFINITION ---
        let gameData = {
            playerName: "Everton Mereles Costa",
            mainMission: "Construir um imp√©rio de IA do zero aos data centers",
            playerStats: {
                xp: 0,
                level: 1,
                xpToNextLevel: 100,
                revenue: 0,
                clients: 0,
                streak: 0,
            },
            phases: [
                {
                    id: "phase0_ia",
                    title: "FASE 0",
                    subtitle: "Automa√ß√£o Sob Demanda",
                    icon: "üîß",
                    timeline: "‚è±Ô∏è Meses 1-6 | üéØ R$5K-15K/m√™s",
                    milestone: { text: "IN√çCIO!", position: "25%" },
                    rewardText: [
                        "T√≠tulo: 'Automatizador Iniciante'",
                        "Desbloqueia: Fase 1 - SaaS",
                        "Conquista: Base s√≥lida de clientes"
                    ],
                    quests: [
                        { id: "q0_ia_1", text: "üéØ Definir nicho inicial (contabilidade/imobili√°ria, consultoria para pequenos neg√≥cios, otimiza√ß√£o para criadores de conte√∫do, etc.)", xp: 20, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_2", text: "üåê Configurar n8n em servidor pr√≥prio", xp: 25, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_n8n_funnel", text: "üîÑ Criar fluxo N8N para funil perp√©tuo de vendas org√¢nicas (capta√ß√£o e convers√£o)", xp: 60, completed: false, obstacles: ["Definir estrat√©gia de conte√∫do org√¢nico", "Configurar gatilhos e integra√ß√µes"], notes: "Foco em automa√ß√£o de lead magnet, email marketing e qualifica√ß√£o." },
                        { id: "q0_ia_3", text: "üìã Fazer 10 diagn√≥sticos gratuitos", xp: 30, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_4", text: "ü§ñ Criar primeira automa√ß√£o completa para cliente", xp: 35, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_5", text: "üí∞ Fechar primeiro contrato de R$1.500+", xp: 50, setRevenue: 1500, clientsGain: 1, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_6", text: "üìà Atingir 5 clientes pagantes", xp: 40, setRevenueBasedOnClients: { baseRate: 1500, count: 5 }, clientsTarget: 5, completed: false, obstacles: [], notes: "" }, // clientTarget para UI, setRevenue para l√≥gica
                        { id: "q0_ia_7", text: "üìö Documentar 10 templates replic√°veis", xp: 25, completed: false, obstacles: [], notes: "" },
                        { id: "q0_ia_8", text: "üéä BOSS: R$10K/m√™s em receita recorrente", xp: 100, setRevenue: 10000, completed: false, obstacles: [], notes: "" }
                    ]
                },
                {
                    id: "phase1_ia",
                    title: "FASE 1",
                    subtitle: "Produtos SaaS",
                    icon: "üíª",
                    timeline: "‚è±Ô∏è Meses 4-12 | üéØ R$20K-50K/m√™s MRR",
                    milestone: { text: "MVP", position: "50%" },
                    rewardText: [
                        "T√≠tulo: 'Fundador de SaaS'",
                        "Desbloqueia: Marketplace + Fase 2",
                        "Conquista: Produto escal√°vel"
                    ],
                    quests: [
                        { id: "q1_ia_1", text: "üîç Identificar automa√ß√£o mais demandada para SaaS", xp: 20, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_2", text: "üõ†Ô∏è Desenvolver MVP do SaaS em 30 dias", xp: 60, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_3", text: "üß™ Beta test com 10 clientes para o SaaS", xp: 30, clientsGain: 10, completed: false, obstacles: [], notes: "Estes s√£o clientes do SaaS, podem ser diferentes dos de automa√ß√£o." },
                        { id: "q1_ia_4", text: "üìä Atingir NPS 50+ para o SaaS", xp: 25, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_5", text: "üöÄ Lan√ßar vers√£o p√∫blica do SaaS", xp: 40, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_6", text: "üë• Conseguir 100 usu√°rios ativos no SaaS", xp: 50, clientsGain: 90, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_7", text: "üí≥ Implementar cobran√ßa autom√°tica para o SaaS", xp: 30, completed: false, obstacles: [], notes: "" },
                        { id: "q1_ia_8", text: "üéä BOSS: R$30K MRR sustent√°vel com o SaaS", xp: 100, setRevenue: 30000, completed: false, obstacles: [], notes: "" }
                    ]
                },
                {
                    id: "phase15_ia",
                    title: "FASE 1.5",
                    subtitle: "Marketplace",
                    icon: "üè™",
                    timeline: "‚è±Ô∏è Meses 8-15 | üéØ Receita passiva",
                    milestone: { text: "SCALE", position: "65%" },
                    rewardText: [
                        "T√≠tulo: 'Marketplace Master'",
                        "Receita passiva estabelecida",
                        "Network de desenvolvedores"
                    ],
                    quests: [
                        { id: "q15_ia_1", text: "üè™ Criar marketplace de templates de automa√ß√£o/IA", xp: 50, completed: false, obstacles: [], notes: "" },
                        { id: "q15_ia_2", text: "üë• Recrutar 5 desenvolvedores parceiros para o marketplace", xp: 30, completed: false, obstacles: [], notes: "" },
                        { id: "q15_ia_3", text: "üí∞ Definir e implementar sistema de comiss√µes (ex: 30% para a plataforma)", xp: 25, completed: false, obstacles: [], notes: "" },
                        { id: "q15_ia_4", text: "üìà Ter 50+ templates de qualidade no marketplace", xp: 40, completed: false, obstacles: [], notes: "" },
                        { id: "q15_ia_5", text: "üéä BOSS: R$10K/m√™s em receita de comiss√µes do marketplace", xp: 100, revenueGain: 10000, completed: false, obstacles: [], notes: "Este ganho √© somado √† receita existente." }
                    ]
                },
                {
                    id: "phase2_ia",
                    title: "FASE 2",
                    subtitle: "Infraestrutura IA",
                    icon: "üèóÔ∏è",
                    timeline: "‚è±Ô∏è Meses 12-24+ | üéØ \"AWS da Am√©rica Latina\"",
                    milestone: { text: "DATACENTER", position: "85%" },
                    rewardText: [
                        "T√≠tulo: 'Imperador da IA'",
                        "Infraestrutura continental",
                        "Legacy empresarial"
                    ],
                    quests: [
                        { id: "q2_ia_1", text: "üåç Estudo de viabilidade para data center (ex: Itaipu)", xp: 30, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_2", text: "ü§ù Formar parcerias estrat√©gicas com empresas de energia/investidores", xp: 40, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_3", text: "üìã Resolver tr√¢mites jur√≠dicos e buscar incentivos fiscais", xp: 25, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_4", text: "üèóÔ∏è Implantar data center piloto funcional", xp: 70, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_5", text: "ü§ñ Desenvolver e hospedar LLMs pr√≥prios ou otimizados", xp: 60, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_6", text: "üí∞ Adquirir primeiros clientes B2B de grande porte para a infraestrutura", xp: 50, clientsGain: 5, revenueGain: 50000, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_7", text: "üåé Iniciar expans√£o da infraestrutura para 3 pa√≠ses da Am√©rica Latina", xp: 80, completed: false, obstacles: [], notes: "" },
                        { id: "q2_ia_8", text: "üéä BOSS FINAL: IPO da empresa ou Aquisi√ß√£o estrat√©gica", xp: 200, completed: false, obstacles: [], notes: "O pin√°culo do imp√©rio!" }
                    ]
                }
            ]
        };

        // --- Constantes e Vari√°veis Globais ---
        let TOTAL_QUESTS = 0;
        const LEVEL_XP_THRESHOLD = [0, 100, 250, 500, 800, 1200, 1700, 2300, 3000, 4000, 5000, 7000, 10000];
        const LEVEL_NAMES = ["Novato", "Automatizador", "Estrategista de Funil", "Fundador SaaS", "Arquiteto de Solu√ß√µes", "Mestre do Marketplace", "Vision√°rio Tecnol√≥gico", "Construtor de Imp√©rios", "Magnata da IA", "Lenda Digital", "Semideus da Inova√ß√£o", "Imperador da IA"];
        let currentOpenQuestId = null;

        // --- DOM Elements Cache ---
        let timelineContainer, progressFill, progressText, mainMissionSubtitle, playerNameDisplay,
            currentLevelDisplay, currentXPDisplay, revenueDisplay, clientsDisplay,
            completedQuestsCountDisplay, streakDisplay, nextQuestTextDisplay, nextQuestDeadlineDisplay,
            achievementPopup, achievementTitle, achievementText, questDetailModal,
            modalQuestTitle, modalQuestDescription, modalQuestObstacles, modalQuestNotes;

        function cacheDOMElements() {
            timelineContainer = document.getElementById('timelineContainer');
            progressFill = document.getElementById('progressFill');
            progressText = document.getElementById('progressText');
            mainMissionSubtitle = document.getElementById('mainMissionSubtitle');
            playerNameDisplay = document.getElementById('playerNameDisplay');
            currentLevelDisplay = document.getElementById('currentLevel');
            currentXPDisplay = document.getElementById('currentXP');
            revenueDisplay = document.getElementById('revenue');
            clientsDisplay = document.getElementById('clients');
            completedQuestsCountDisplay = document.getElementById('completedQuestsCount');
            streakDisplay = document.getElementById('streak');
            nextQuestTextDisplay = document.getElementById('nextQuestText');
            nextQuestDeadlineDisplay = document.getElementById('nextQuestDeadline');
            achievementPopup = document.getElementById('achievementPopup');
            achievementTitle = document.getElementById('achievementTitle');
            achievementText = document.getElementById('achievementText');
            questDetailModal = document.getElementById('questDetailModal');
            modalQuestTitle = document.getElementById('modalQuestTitle');
            modalQuestDescription = document.getElementById('modalQuestDescription');
            modalQuestObstacles = document.getElementById('modalQuestObstacles');
            modalQuestNotes = document.getElementById('modalQuestNotes');
        }

        // --- Game Logic ---
        function calculateTotalQuests() {
            TOTAL_QUESTS = gameData.phases.reduce((sum, phase) => sum + phase.quests.length, 0);
        }

        function saveProgress() {
            localStorage.setItem('evertonQuestGameData_IA_v3', JSON.stringify(gameData)); // Nova vers√£o
        }

        function loadProgress() {
            const savedData = localStorage.getItem('evertonQuestGameData_IA_v3');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                gameData = {
                    ...gameData,
                    ...parsedData,
                    playerStats: {
                        ...gameData.playerStats,
                        ...(parsedData.playerStats || {})
                    },
                    phases: gameData.phases.map(defaultPhase => {
                        const savedPhase = parsedData.phases ? parsedData.phases.find(sp => sp.id === defaultPhase.id) : null;
                        if (savedPhase) {
                            return {
                                ...defaultPhase,
                                ...savedPhase,
                                quests: defaultPhase.quests.map(defaultQuest => {
                                    const savedQuest = savedPhase.quests ? savedPhase.quests.find(sq => sq.id === defaultQuest.id) : null;
                                    return savedQuest ? { ...defaultQuest, ...savedQuest } : defaultQuest;
                                })
                            };
                        }
                        return defaultPhase;
                    })
                };
            }
            calculateTotalQuests();
        }

        function getQuestById(questId) {
            for (const phase of gameData.phases) {
                const quest = phase.quests.find(q => q.id === questId);
                if (quest) return quest;
            }
            return null;
        }

        function toggleQuest(questId) {
            const quest = getQuestById(questId);
            if (!quest) return;

            const questWasCompleted = quest.completed;
            quest.completed = !quest.completed;

            if (quest.completed && !questWasCompleted) { // Quest ACABA de ser completada
                gameData.playerStats.xp += quest.xp || 0;
                gameData.playerStats.streak++;

                // L√≥gica de Receita e Clientes
                if (quest.setRevenue) {
                    gameData.playerStats.revenue = quest.setRevenue;
                } else if (quest.setRevenueBasedOnClients) {
                    // Garantir que o n√∫mero de clientes ativos reflita o alvo da quest antes de calcular
                    if (quest.clientsTarget && gameData.playerStats.clients < quest.clientsTarget) {
                         gameData.playerStats.clients = quest.clientsTarget; // Define o n√∫mero de clientes para o alvo
                    }
                    gameData.playerStats.revenue = quest.setRevenueBasedOnClients.baseRate * gameData.playerStats.clients;
                } else if (quest.revenueGain) {
                    gameData.playerStats.revenue += quest.revenueGain;
                }

                if (quest.clientsGain) {
                    gameData.playerStats.clients += quest.clientsGain;
                } else if (quest.clientsTarget && gameData.playerStats.clients < quest.clientsTarget) {
                     // Se setRevenueBasedOnClients j√° cuidou disso, n√£o precisa fazer de novo
                     // mas se for uma quest apenas de alvo de clientes sem setRevenueBasedOnClients:
                    if (!quest.setRevenueBasedOnClients) {
                        gameData.playerStats.clients = quest.clientsTarget;
                    }
                }


                showAchievement("‚ú® Quest Conclu√≠da!", `Voc√™ ganhou ${quest.xp || 0} XP por completar: ${quest.text}`);

            } else if (!quest.completed && questWasCompleted) { // Quest est√° sendo DESMARCADA
                gameData.playerStats.xp -= quest.xp || 0;
                if(gameData.playerStats.xp < 0) gameData.playerStats.xp = 0;
                gameData.playerStats.streak = Math.max(0, gameData.playerStats.streak -1 );

                // Reverter ganhos (l√≥gica mais complexa, idealmente deveria reverter ao estado anterior)
                // Por simplicidade, vamos apenas subtrair ou zerar se for 'setRevenue'
                // Esta parte de "desfazer" receita √© complexa e pode precisar de um hist√≥rico.
                // Para este sistema, ao desmarcar, a receita pode n√£o voltar exatamente ao valor anterior
                // se m√∫ltiplas quests que usam "setRevenue" foram desmarcadas em ordem diferente.
                if (quest.setRevenue) {
                    // Idealmente, procurar a quest anterior que definiu a receita.
                    // Por ora, uma simplifica√ß√£o: se desmarcar uma quest "setRevenue",
                    // a receita pode precisar ser recalculada com base nas outras quests completas.
                    // Ou, para simplificar mais ainda, n√£o reverter "setRevenue" automaticamente ao desmarcar,
                    // pois o usu√°rio pode estar apenas corrigindo um clique.
                    // A forma mais segura de reverter √© recalcular a receita total baseada em TODAS as quests completas.
                } else if (quest.setRevenueBasedOnClients) {
                    // Similar ao setRevenue
                } else if (quest.revenueGain) {
                    gameData.playerStats.revenue -= quest.revenueGain;
                }
                if (quest.clientsGain) {
                    gameData.playerStats.clients -= quest.clientsGain;
                }
                // Para simplificar o "desfazer", vamos for√ßar um rec√°lculo da receita total ao desmarcar.
                recalculateTotalRevenueAndClients();
            }
            
            checkLevelUp();
            updateAllUI();
            saveProgress();
        }
        
        function recalculateTotalRevenueAndClients() {
            let newRevenue = 0;
            let newClients = 0;
            let lastSetRevenue = 0; // Para lidar com quests que definem a receita total
            let lastSetRevenueBasedOnClients = null;
            let clientMilestonesHit = {}; // Para setRevenueBasedOnClients

            gameData.phases.forEach(phase => {
                phase.quests.forEach(quest => {
                    if (quest.completed) {
                        if (quest.clientsGain) newClients += quest.clientsGain;
                        if (quest.clientsTarget && !clientMilestonesHit[quest.id]) {
                             // Se a quest tem um target de clientes e ainda n√£o foi "contabilizada" para esse target
                            if (newClients < quest.clientsTarget) newClients = quest.clientsTarget; // Atualiza se o target for maior
                            clientMilestonesHit[quest.id] = true; // Marca como contabilizada
                        }

                        if (quest.setRevenue) {
                            lastSetRevenue = quest.setRevenue; // A √∫ltima quest "setRevenue" completada define a base
                            newRevenue = lastSetRevenue; // Atualiza a receita
                        } else if (quest.setRevenueBasedOnClients) {
                            lastSetRevenueBasedOnClients = quest.setRevenueBasedOnClients; // Guarda a regra
                            // O c√°lculo final da receita ser√° feito ap√≥s processar todos os clientes
                        } else if (quest.revenueGain) {
                            if(lastSetRevenue > 0 || lastSetRevenueBasedOnClients){
                                // Se uma quest "setRevenue" j√° ocorreu, os revenueGain s√£o somados a ela
                                newRevenue += quest.revenueGain;
                            } else {
                                // Caso contr√°rio, apenas soma ao que j√° tinha (se n√£o houver setRevenue)
                                newRevenue += quest.revenueGain;
                            }
                        }
                    }
                });
            });

            // Se houve uma quest "setRevenueBasedOnClients" como a √∫ltima definidora de receita
            if(lastSetRevenueBasedOnClients && lastSetRevenue === 0) { // Apenas se n√£o houver um "setRevenue" mais recente
                newRevenue = lastSetRevenueBasedOnClients.baseRate * newClients;
            } else if (lastSetRevenue > 0) { // Se a √∫ltima foi "setRevenue", ela j√° definiu newRevenue
                 // os revenueGains j√° foram somados a 'newRevenue'
            }
            // Se n√£o houver nenhuma quest "setRevenue" ou "setRevenueBasedOnClients", newRevenue ter√° a soma dos revenueGains.

            gameData.playerStats.revenue = newRevenue;
            gameData.playerStats.clients = newClients;
        }


        function checkLevelUp() {
            const oldLevel = gameData.playerStats.level;
            let newLevel = 1;
            for (let i = LEVEL_XP_THRESHOLD.length - 1; i >= 0; i--) {
                if (gameData.playerStats.xp >= LEVEL_XP_THRESHOLD[i]) {
                    newLevel = i + 1;
                    break;
                }
            }
            gameData.playerStats.level = newLevel;

            if(gameData.playerStats.level > oldLevel) {
                showAchievement("üöÄ LEVEL UP!", `Voc√™ alcan√ßou o N√≠vel ${gameData.playerStats.level}: ${LEVEL_NAMES[gameData.playerStats.level -1]}!`);
            }
            gameData.playerStats.xpToNextLevel = LEVEL_XP_THRESHOLD[gameData.playerStats.level] || LEVEL_XP_THRESHOLD[LEVEL_XP_THRESHOLD.length-1] + 2000;
        }
        
        function isPhaseCompleted(phase) {
            return phase.quests.every(q => q.completed);
        }

        function isPhaseActive(phase) {
            if (isPhaseCompleted(phase)) return false;
            if (phase.quests.some(q => q.completed)) return true;

            for (const p of gameData.phases) {
                if (!isPhaseCompleted(p)) {
                    return p.id === phase.id;
                }
            }
            return false;
        }

        // --- UI Rendering ---
        function renderPhases() {
            timelineContainer.innerHTML = '';
            gameData.phases.forEach(phaseData => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase';
                phaseDiv.id = phaseData.id;

                if (isPhaseCompleted(phaseData)) phaseDiv.classList.add('completed');
                if (isPhaseActive(phaseData)) phaseDiv.classList.add('active');

                if (phaseData.milestone) {
                    const milestoneMarker = document.createElement('div');
                    milestoneMarker.className = 'milestone-marker';
                    milestoneMarker.style.left = phaseData.milestone.position || '50%';
                    milestoneMarker.textContent = phaseData.milestone.text;
                    phaseDiv.appendChild(milestoneMarker);
                }

                const headerDiv = document.createElement('div');
                headerDiv.className = 'phase-header';
                const mainTitle = phaseData.title;
                const subTitle = phaseData.subtitle || '';


                headerDiv.innerHTML = `
                    <div class="phase-icon">${phaseData.icon}</div>
                    <div class="phase-title-container">
                        <div class="phase-title">${mainTitle}</div>
                        <div class="phase-subtitle">${subTitle}</div>
                    </div>
                `;
                phaseDiv.appendChild(headerDiv);

                const timelineDescDiv = document.createElement('div');
                timelineDescDiv.className = 'phase-timeline-desc';
                timelineDescDiv.textContent = phaseData.timeline;
                phaseDiv.appendChild(timelineDescDiv);

                const questListDiv = document.createElement('div');
                questListDiv.className = 'quest-list';
                phaseData.quests.forEach(questData => {
                    const questItemDiv = document.createElement('div');
                    questItemDiv.className = 'quest-item';
                    if (questData.completed) questItemDiv.classList.add('completed');
                    
                    questItemDiv.innerHTML = `
                        <div class="quest-checkbox" onclick="event.stopPropagation(); toggleQuest('${questData.id}')"></div>
                        <div class="quest-text" onclick="openQuestDetailModal('${questData.id}')">${questData.text}</div>
                        <div class="quest-xp">${questData.xp || 0} XP</div>
                    `;
                    questListDiv.appendChild(questItemDiv);
                });
                phaseDiv.appendChild(questListDiv);

                if (phaseData.rewardText && phaseData.rewardText.length > 0) {
                    const rewardSectionDiv = document.createElement('div');
                    rewardSectionDiv.className = 'reward-section';
                    let rewardsHTML = '<div class="reward-title">üèÜ RECOMPENSAS</div>';
                    phaseData.rewardText.forEach(reward => {
                        rewardsHTML += `<div class="reward-item">‚Ä¢ ${reward}</div>`;
                    });
                    rewardSectionDiv.innerHTML = rewardsHTML;
                    phaseDiv.appendChild(rewardSectionDiv);
                }
                timelineContainer.appendChild(phaseDiv);
            });
        }

        function updateStatsPanel() {
            playerNameDisplay.textContent = `üìä STATS DE ${gameData.playerName.toUpperCase()}`;
            currentLevelDisplay.textContent = `${gameData.playerStats.level} (${LEVEL_NAMES[gameData.playerStats.level - 1] || 'Max'})`;
            currentXPDisplay.textContent = `${gameData.playerStats.xp} / ${gameData.playerStats.xpToNextLevel}`;
            revenueDisplay.textContent = `R$ ${gameData.playerStats.revenue.toLocaleString('pt-BR')}`;
            clientsDisplay.textContent = gameData.playerStats.clients;
            
            const completedCount = gameData.phases.reduce((sum, phase) => sum + phase.quests.filter(q => q.completed).length, 0);
            completedQuestsCountDisplay.textContent = `${completedCount}/${TOTAL_QUESTS}`;
            streakDisplay.textContent = `${gameData.playerStats.streak} dias`;
        }

        function updateOverallProgress() {
            const completedCount = gameData.phases.reduce((sum, phase) => sum + phase.quests.filter(q => q.completed).length, 0);
            const percentage = TOTAL_QUESTS > 0 ? (completedCount / TOTAL_QUESTS) * 100 : 0;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `Progresso Geral: ${Math.floor(percentage)}%`;
            const nextMilestonePercentage = Math.ceil(percentage / 25) * 25;
            if (percentage < 100) {
                progressText.textContent += ` | Pr√≥xima recompensa em: ${nextMilestonePercentage > 100 ? 100 : nextMilestonePercentage}%`;
            }
        }
        
        function updateNextQuestDisplay() {
            let nextQuest = null;
            for (const phase of gameData.phases) {
                for (const quest of phase.quests) {
                    if (!quest.completed) {
                        nextQuest = quest;
                        break;
                    }
                }
                if (nextQuest) break;
            }

            if (nextQuest) {
                nextQuestTextDisplay.textContent = nextQuest.text;
                const phaseIdPrefix = nextQuest.id.substring(0, nextQuest.id.indexOf('_'));
                let days = 7;
                if (phaseIdPrefix === 'q1') days = 14;
                if (phaseIdPrefix === 'q15') days = 20;
                if (phaseIdPrefix === 'q2') days = 30;
                nextQuestDeadlineDisplay.textContent = nextQuest.deadline || `Deadline: ${days} dias`;
            } else {
                nextQuestTextDisplay.textContent = "üéä PARAB√âNS! TODAS AS QUESTS CONCLU√çDAS!";
                nextQuestDeadlineDisplay.textContent = "‚ú® VOC√ä √â O IMPERADOR DA IA!";
            }
        }
        
        function updateAllUI() {
            if (!timelineContainer) cacheDOMElements();
            document.getElementById('mainMissionTitle').textContent = `üó∫Ô∏è MAPA DE QUEST`;
            mainMissionSubtitle.textContent = `üéØ Miss√£o Principal: ${gameData.mainMission}`;
            renderPhases();
            updateStatsPanel();
            updateOverallProgress();
            updateNextQuestDisplay();
        }

        // --- Achievement Popup Logic ---
        function showAchievement(title, text) {
            achievementTitle.textContent = title;
            achievementText.innerHTML = text.replace(/\n/g, '<br>');
            achievementPopup.classList.add('show');
        }

        function closeAchievement() {
            achievementPopup.classList.remove('show');
        }

        // --- Quest Detail Modal Logic ---
        function openQuestDetailModal(questId) {
            currentOpenQuestId = questId;
            const quest = getQuestById(questId);
            if (!quest) return;

            modalQuestTitle.textContent = quest.text;
            modalQuestDescription.textContent = quest.description || "Nenhuma descri√ß√£o adicional.";
            
            modalQuestObstacles.innerHTML = '';
            if (quest.obstacles && quest.obstacles.length > 0) {
                quest.obstacles.forEach(obs => {
                    const li = document.createElement('li');
                    li.textContent = obs;
                    modalQuestObstacles.appendChild(li);
                });
            } else {
                modalQuestObstacles.innerHTML = '<li>Nenhum obst√°culo listado.</li>';
            }
            
            modalQuestNotes.value = quest.notes || '';
            questDetailModal.style.display = "block";
        }

        function closeQuestDetailModal() {
            saveQuestNotes();
            questDetailModal.style.display = "none";
            currentOpenQuestId = null;
        }

        function saveQuestNotes() {
            if (currentOpenQuestId) {
                const quest = getQuestById(currentOpenQuestId);
                if (quest) {
                    quest.notes = modalQuestNotes.value;
                    saveProgress();
                }
            }
        }
        
        // Event Listeners for Modal ---
        function setupModalEventListeners() {
            window.onclick = function(event) {
                if (event.target == questDetailModal) {
                    closeQuestDetailModal();
                }
            }
            window.onkeydown = function(event) {
                if (event.key === "Escape" && questDetailModal.style.display === "block") {
                    closeQuestDetailModal();
                }
            }
        }

        // --- Initialization ---
        function initializeGame() {
            cacheDOMElements();
            loadProgress();
            recalculateTotalRevenueAndClients(); // Garante que a receita e clientes estejam corretos no carregamento
            checkLevelUp();
            updateAllUI();
            setupModalEventListeners();
            console.log("üéÆ Mapa de Quest do Everton Carregado! v3");
        }

        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>
